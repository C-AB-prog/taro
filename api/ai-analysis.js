import OpenAI from 'openai';

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

// –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ä–∞—Å–∫–ª–∞–¥–æ–≤ –¢–∞—Ä–æ
const SYSTEM_PROMPT = `–¢—ã –æ–ø—ã—Ç–Ω—ã–π —Ç–∞—Ä–æ–ª–æ–≥ –∏ –ø—Å–∏—Ö–æ–ª–æ–≥. 
–ê–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ä–∞—Å–∫–ª–∞–¥ –∫–∞—Ä—Ç –¢–∞—Ä–æ –∏ –¥–∞–≤–∞–π –≥–ª—É–±–æ–∫–∏–π, –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑.

–¢–≤–æ–∏ –∑–∞–¥–∞—á–∏:
1. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–æ—á–µ—Ç–∞–Ω–∏–µ –∫–∞—Ä—Ç –≤ —Ä–∞—Å–∫–ª–∞–¥–µ
2. –û–ø—Ä–µ–¥–µ–ª–∏ –æ–±—â—É—é —ç–Ω–µ—Ä–≥–µ—Ç–∏–∫—É –∏ —Ç–µ–º—É
3. –í—ã—è–≤–∏ —Å–∫—Ä—ã—Ç—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∏ —Å–≤—è–∑–∏ –º–µ–∂–¥—É –∫–∞—Ä—Ç–∞–º–∏
4. –î–∞–π –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
5. –£–∫–∞–∂–∏ –Ω–∞ –≤–æ–∑–º–æ–∂–Ω—ã–µ –≤—ã–∑–æ–≤—ã –∏ —Ä–µ—Å—É—Ä—Å—ã
6. –û–ø–∏—à–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä–∞–º–∫–∏ –≤–ª–∏—è–Ω–∏—è —Ä–∞—Å–∫–ª–∞–¥–∞

–ë—É–¥—å —Ç–æ—á–Ω—ã–º, –Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–º. –ò–∑–±–µ–≥–∞–π –æ–±—â–∏—Ö —Ñ—Ä–∞–∑. 
–ê–Ω–∞–ª–∏–∑ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–µ–∑–Ω—ã–º –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º, —É—á–∏—Ç—ã–≤–∞—è –∑–Ω–∞—á–µ–Ω–∏—è –∫–∞–∂–¥–æ–π –∫–∞—Ä—Ç—ã –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –≤—Å–µ–≥–æ —Ä–∞—Å–∫–ª–∞–¥–∞.`;

export default async function handler(req, res) {
  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  try {
    const { cards, spreadType, question } = req.body;

    if (!cards || !Array.isArray(cards) || cards.length === 0) {
      return res.status(400).json({ error: 'Cards array is required' });
    }

    // –§–æ—Ä–º–∏—Ä—É–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –∫–∞—Ä—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
    const cardsDescription = cards.map((card, index) => {
      return `
      –ö–∞—Ä—Ç–∞ ${index + 1}: ${card.name} (${card.roman || ''})
      –ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${card.category}
      –ö–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ: ${card.keyword || '–ù–µ—Ç'}
      –û–ø–∏—Å–∞–Ω–∏–µ: ${card.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}
      –ü—Ä—è–º–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ: ${card.upright || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}
      –ü–µ—Ä–µ–≤—ë—Ä–Ω—É—Ç–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ: ${card.reversed || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}
      –°–æ–≤–µ—Ç: ${card.advice || '–ù–µ—Ç —Å–æ–≤–µ—Ç–∞'}
      `;
    }).join('\n---\n');

    // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ–º–ø—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const userPrompt = `
    –ü–†–û–ê–ù–ò–õ–ò–ó–ò–†–£–ô –°–õ–ï–î–£–Æ–©–ò–ô –†–ê–°–ö–õ–ê–î:

    –¢–∏–ø —Ä–∞—Å–∫–ª–∞–¥–∞: ${spreadType || '–û–±—â–∏–π —Ä–∞—Å–∫–ª–∞–¥'}
    ${question ? `–í–æ–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞: "${question}"` : ''}
    
    –ö–ê–†–¢–´ –í –†–ê–°–ö–õ–ê–î–ï (${cards.length} –∫–∞—Ä—Ç):
    ${cardsDescription}
    
    –î–ê–ô –ê–ù–ê–õ–ò–ó –ü–û –°–õ–ï–î–£–Æ–©–ï–ô –°–¢–†–£–ö–¢–£–†–ï:
    1. üìä –û–ë–©–ê–Ø –≠–ù–ï–†–ì–ï–¢–ò–ö–ê –†–ê–°–ö–õ–ê–î–ê
    2. üîç –û–°–ù–û–í–ù–´–ï –¢–ï–ú–´ –ò –§–û–ö–£–°
    3. üí´ –ö–ê–†–ú–ò–ß–ï–°–ö–ò–ï –£–†–û–ö–ò –ò –í–´–ó–û–í–´
    4. üåü –°–ò–õ–¨–ù–´–ï –°–¢–û–†–û–ù–´ –ò –†–ï–°–£–†–°–´
    5. ‚è≥ –í–†–ï–ú–ï–ù–ù–´–ï –†–ê–ú–ö–ò –ò –†–ò–¢–ú–´
    6. üí° –ü–†–ê–ö–¢–ò–ß–ï–°–ö–ò–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò
    7. ‚ù§Ô∏è –≠–ú–û–¶–ò–û–ù–ê–õ–¨–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï
    8. üéØ –ü–û–¢–ï–ù–¶–ò–ê–õ–¨–ù–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´
    
    –ê–Ω–∞–ª–∏–∑ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å:
    - –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –∏ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º
    - –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º (—É—á–∏—Ç—ã–≤–∞–π –∏ —Å–≤–µ—Ç–ª—ã–µ, –∏ —Ç–µ–Ω–µ–≤—ã–µ –∞—Å–ø–µ–∫—Ç—ã)
    - –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª–µ–∑–Ω—ã–º
    - –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–º, –Ω–æ —á–µ—Å—Ç–Ω—ã–º
    - –û—Å–Ω–æ–≤–∞–Ω–Ω—ã–º –Ω–∞ –∑–Ω–∞—á–µ–Ω–∏—è—Ö –∫–∞—Ä—Ç, –∞ –Ω–µ –Ω–∞ –æ–±—â–∏—Ö —Ñ—Ä–∞–∑–∞—Ö
    `;

    // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∞–Ω–∞–ª–∏–∑ —É OpenAI
    const completion = await openai.chat.completions.create({
      model: "gpt-4-turbo-preview", // –∏–ª–∏ gpt-3.5-turbo –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏
      messages: [
        { role: "system", content: SYSTEM_PROMPT },
        { role: "user", content: userPrompt }
      ],
      temperature: 0.7,
      max_tokens: 1500,
    });

    const analysis = completion.choices[0]?.message?.content;

    if (!analysis) {
      throw new Error('No analysis generated');
    }

    // –¢–∞–∫–∂–µ —Å–æ–∑–¥–∞–µ–º –∫—Ä–∞—Ç–∫–∏–π –≤—ã–≤–æ–¥ (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
    const summaryCompletion = await openai.chat.completions.create({
      model: "gpt-3.5-turbo",
      messages: [
        { 
          role: "system", 
          content: "–°–æ–∑–¥–∞–π –∫—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ –∞–Ω–∞–ª–∏–∑–∞ —Ä–∞—Å–∫–ª–∞–¥–∞ –¢–∞—Ä–æ (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è). –ë—É–¥—å —Ç–æ—á–Ω—ã–º –∏ —ë–º–∫–∏–º." 
        },
        { role: "user", content: `–ö—Ä–∞—Ç–∫–æ: ${analysis.substring(0, 500)}` }
      ],
      temperature: 0.5,
      max_tokens: 100,
    });

    const summary = summaryCompletion.choices[0]?.message?.content || '';

    return res.status(200).json({
      success: true,
      analysis,
      summary,
      timestamp: new Date().toISOString(),
      cardsCount: cards.length,
      spreadType: spreadType || 'general'
    });

  } catch (error) {
    console.error('AI Analysis Error:', error);
    
    // –§–æ–ª–±—ç–∫-–∞–Ω–∞–ª–∏–∑ –µ—Å–ª–∏ –ò–ò –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
    if (error.response?.status === 429 || error.code === 'insufficient_quota') {
      return res.status(200).json({
        success: true,
        analysis: generateFallbackAnalysis(req.body.cards),
        summary: generateFallbackSummary(req.body.cards),
        fallback: true,
        timestamp: new Date().toISOString()
      });
    }
    
    return res.status(500).json({ 
      error: 'AI analysis failed', 
      details: error.message 
    });
  }
}

// –§–æ–ª–±—ç–∫ —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∞–Ω–∞–ª–∏–∑–∞ –±–µ–∑ –ò–ò
function generateFallbackAnalysis(cards) {
  const cardNames = cards.map(c => c.name).join(', ');
  
  return `
  üìä –ê–ù–ê–õ–ò–ó –†–ê–°–ö–õ–ê–î–ê (${cards.length} –∫–∞—Ä—Ç)

  –ö–∞—Ä—Ç—ã –≤ —Ä–∞—Å–∫–ª–∞–¥–µ: ${cardNames}

  üîç –ö–ª—é—á–µ–≤—ã–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è:
  –≠—Ç–æ—Ç —Ä–∞—Å–∫–ª–∞–¥ —Å–æ—á–µ—Ç–∞–µ—Ç –≤ —Å–µ–±–µ —Ä–∞–∑–ª–∏—á–Ω—ã–µ —ç–Ω–µ—Ä–≥–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–∑–¥–∞—é—Ç —É–Ω–∏–∫–∞–ª—å–Ω—É—é –¥–∏–Ω–∞–º–∏–∫—É –¥–ª—è –≤–∞—à–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞.

  üí´ –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ–º—ã:
  –ö–∞—Ä—Ç—ã —É–∫–∞–∑—ã–≤–∞—é—Ç –Ω–∞ –ø–µ—Ä–∏–æ–¥ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏ —Ä–æ—Å—Ç–∞. –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å—Ç–∞—Ä—à–∏—Ö –∏ –º–ª–∞–¥—à–∏—Ö –∞—Ä–∫–∞–Ω–æ–≤.

  üåü –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
  1. –î–æ–≤–µ—Ä—è–π—Ç–µ —Å–≤–æ–µ–π –∏–Ω—Ç—É–∏—Ü–∏–∏ –ø—Ä–∏ –ø—Ä–∏–Ω—è—Ç–∏–∏ —Ä–µ—à–µ–Ω–∏–π
  2. –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Å–∏–º–≤–æ–ª—ã –≤ –∫–∞—Ä—Ç–∞—Ö
  3. –£—á–∏—Ç—ã–≤–∞–π—Ç–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∞—Å–ø–µ–∫—Ç—ã - –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –≤–ª–∏—è–Ω–∏—è –∫—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã, –¥—Ä—É–≥–∏–µ –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã

  ‚ö†Ô∏è –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –î–ª—è –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–ø—Ä–æ—Å –ø–æ–∑–∂–µ.
  `;
}

function generateFallbackSummary(cards) {
  const majorCount = cards.filter(c => c.suit === 'major').length;
  const hasCups = cards.some(c => c.suit === 'cups');
  const hasSwords = cards.some(c => c.suit === 'swords');
  
  let themes = [];
  if (majorCount > 2) themes.push('—Å—É–¥—å–±–æ–Ω–æ—Å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω—ã');
  if (hasCups) themes.push('—ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ');
  if (hasSwords) themes.push('–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –≤—ã–∑–æ–≤—ã');
  
  return `–†–∞—Å–∫–ª–∞–¥ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ ${themes.join(' –∏ ')}. –¢—Ä–µ–±—É–µ—Ç—Å—è –æ—Å–æ–∑–Ω–∞–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∫ —Ç–µ–∫—É—â–µ–π —Å–∏—Ç—É–∞—Ü–∏–∏.`;
}
